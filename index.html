<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Delivery Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .tracking-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 260px;
        }
        .status-indicator { display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .dot { height: 10px; width: 10px; border-radius: 50%; background: #bbb; }
        .online { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
    </style>
</head>
<body>

    <div class="tracking-panel">
        <div class="status-indicator">
            <div id="dot" class="dot"></div>
            <span id="status-text">Attempting Connection...</span>
        </div>
        <hr>
        <p><strong>Device ID:</strong> <span id="display-id">None</span></p>
        <p><strong>Speed:</strong> <span id="speed">0</span> km/h</p>
        <p><strong>Address:</strong> <br><small id="address">Waiting for data...</small></p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Initialize Map
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let marker;
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('id'); // e.g., ?id=0001
        document.getElementById('display-id').innerText = targetId || "No ID in URL";

        // 2. WebSocket Credentials
        const username = "partysocial"; 
        const password = "admin"; 
        const wsUrl = `wss://beta.mylocatorplus.com/locator-clients/api/socket?username=${username}&password=${password}`;

        console.log("Initializing WebSocket connection...");
        const socket = new WebSocket(wsUrl);

        // 3. Connection Handlers
        socket.onopen = () => {
            console.log("âœ… WebSocket Connected Successfully!");
            document.getElementById('dot').classList.add('online');
            document.getElementById('status-text').innerText = "Live: Connected";
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log("ðŸ“© Raw Data Received:", data); // View this in F12 Console

                // IMPORTANT: The PDF shows 'deviceld' (lowercase L)
                if (data.deviceld == targetId || data.deviceId == targetId) {
                    const { latitude, longitude, speed, address, state } = data;

                    // Update UI
                    document.getElementById('speed').innerText = speed || 0;
                    document.getElementById('address').innerText = address || "Address not available";

                    // Update Map
                    const pos = [latitude, longitude];
                    if (!marker) {
                        marker = L.marker(pos).addTo(map);
                        map.setView(pos, 16);
                    } else {
                        marker.setLatLng(pos);
                        map.panTo(pos);
                    }
                } else {
                    console.log(`Ignoring data for ID: ${data.deviceld || data.deviceId}. Looking for: ${targetId}`);
                }
            } catch (err) {
                console.error("âŒ Error parsing message:", err);
            }
        };

        socket.onerror = (error) => {
            console.error("WebSocket Error Observed:", error);
            document.getElementById('status-text').innerText = "Connection Error";
        };

        socket.onclose = (event) => {
            console.warn("WebSocket Closed. Code:", event.code, "Reason:", event.reason);
            document.getElementById('dot').classList.remove('online');
            document.getElementById('status-text').innerText = "Disconnected";
        };
    </script>
</body>
</html>
